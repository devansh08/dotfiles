#!/usr/bin/env bash

# Reference: https://raw.githubusercontent.com/jluttine/rofi-power-menu/refs/heads/master/rofi-power-menu

# This script defines just a mode for rofi instead of being a self-contained
# executable that launches rofi by itself. This makes it more flexible than
# running rofi inside this script as now the user can call rofi as one pleases.
# For instance:
#
#   rofi -show powermenu -modi powermenu:./rofi-power-menu
#
# See README.md for more information.

set -eu

all=(lock logout suspend shutdown reboot)

declare -A texts
texts[lock]="lock"
texts[logout]="log out"
texts[suspend]="sleep"
texts[shutdown]="shut down"
texts[reboot]="reboot"

declare -A actions
actions[lock]="hyprlock"
actions[logout]="swaymsg exit"
actions[suspend]="hyprlock & sleep 1 && systemctl suspend"
actions[shutdown]="systemctl poweroff"
actions[reboot]="systemctl reboot"

confirmations=(shutdown reboot)

function write_message {
  echo -n "<span font_size=\"medium\">$1</span>"
}

function print_selection {
  echo -e "$1" | $(
    read -r -d '' entry
    echo "echo $entry"
  )
}

declare -A messages
declare -A confirmationMessages
for entry in "${all[@]}"; do
  messages[$entry]=$(write_message "${texts[$entry]^}")
done
for entry in "${all[@]}"; do
  confirmationMessages[$entry]=$(write_message "Yes, ${texts[$entry]}")
done
confirmationMessages[cancel]=$(write_message "No, cancel")

echo -e "\0no-custom\x1ftrue"
echo -e "\0markup-rows\x1ftrue"

if [ $# -gt 0 ]; then
  selection="${@}"
else
  if [ -n "${selectionID+x}" ]; then
    selection="${messages[$selectionID]}"
  fi
fi

if [ -z "${selection+x}" ]; then
  echo -e "\0prompt\x1fPower"
  for entry in "${all[@]}"; do
    echo -e "${messages[$entry]}"
  done
else
  for entry in "${all[@]}"; do
    if [ "$selection" = "$(print_selection "${messages[$entry]}")" ]; then
      for confirmation in "${confirmations[@]}"; do
        if [ "$entry" = "$confirmation" ]; then
          echo -e "\0prompt\x1fConfirm"
          echo -e "${confirmationMessages[$entry]}"
          echo -e "${confirmationMessages[cancel]}"
          exit 0
        fi
      done
      selection=$(print_selection "${confirmationMessages[$entry]}")
    fi
    if [ "$selection" = "$(print_selection "${confirmationMessages[$entry]}")" ]; then
      eval "${actions[$entry]}"
      exit 0
    fi
    if [ "$selection" = "$(print_selection "${confirmationMessages[cancel]}")" ]; then
      exit 0
    fi
  done
  echo "Invalid selection: $selection" >&2
  exit 1
fi
